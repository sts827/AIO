<!DOCTYPE html>
<html lang="ko" xmlns="http://www.w3.org/1999/xhtml"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security"
      xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>웨이챗</title>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/sockjs-client/1.5.0/sockjs.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/stomp.js/2.3.3/stomp.min.js"></script>
</head>
<body>
<h1>Chat Application</h1>

<!-- 채팅 메시지 표시를 위한 영역 -->
<div id="roomLists" class="rooms"></div>

<div id="chatMessages"></div>

<!-- 개별 채팅 입력 폼 -->
<!--<input type="text" id="privateChatInput" placeholder="Enter private chat message" />-->
<!--<button onclick="sendPrivateMessage()">Send Private Message</button>-->



<!-- 그룹 채팅 입력 폼 -->
<!--<input type="text" id="groupChatInput" placeholder="Enter group chat message" />-->
<!--<button onclick="sendGroupMessage()">Send Group Message</button>-->

<script th:inline="javascript">
    let socket = new SockJS('/chat'); // WebSocket 연결을 위한 SockJS 객체 생성
    let stompClient = Stomp.over(socket); // SockJS 객체를 사용하여 Stomp 클라이언트 생성

    let uid = "anonymous";


    $(document).ready(function(){

        // uid
        uid = Math.random()*10;

        // WebSocket 연결 시 호출되는 콜백 함수
        stompClient.connect({}, function(frame) {
            console.log('Connected: ' + frame);

            // 개별 채팅 구독 (수신) 처리
            stompClient.subscribe('/private', function(message) {
                console.log("message: ",message);
                showMessage(JSON.parse(message.body));
            });

            // // 그룹 채팅 구독 (수신) 처리
            // stompClient.subscribe('/group', function(message) {
            //     showMessage(JSON.parse(message.body));
            // });
        });

        loadChatRoom();
    })

    function loadChatRoom(){
        $.ajax({
            url:"/api/getRooms",
            success:function(data,status){
                if (data.result.length < 1 || data == undefined){
                    console.log("no-data");
                }else{
                    let roomContainer = document.querySelector("#roomLists");
                    let ul = document.createElement("ul");

                    let items = data.result;

                    Array.from(items).forEach(function(item){
                        let li = document.querySelector("li");
                        li.innerHTML=`<div class="chat-room">${item.room_name}</div>`
                        ul.appendChild(li);
                    });

                    roomContainer.appendChild(ul);

                }
            },
            error:function(){

            }
        })
    }

    // 개별 채팅 메시지 전송
    function sendPrivateMessage() {
        console.log("send Private message: ");
        // let user_id = 'receiverId'; // 수신자 ID 설정
        let message = document.getElementById('privateChatInput').value;
        console.log("message: ",message);

        let chatMessage = {
            user_id: uid, // 발신자 ID 설정
            room_id:1,
            content: message
        };

        stompClient.send('/app/privateChat', {}, JSON.stringify(chatMessage));
    }

    // 그룹 채팅 메시지 전송
    function sendGroupMessage() {
        let roomId = 'roomId'; // 채팅 방 ID 설정
        let message = document.getElementById('groupChatInput').value;

        let chatMessage = {
            user_id: uid, // 발신자 ID 설정
            room_id: roomId,
            content: message
        };

        stompClient.send('/app/groupChat', {}, JSON.stringify(chatMessage));
    }

    // 채팅 메시지 표시
    function showMessage(message) {
        console.log("message: ",message);
        let chatMessages = document.getElementById('chatMessages');
        let messageElement = document.createElement('p');
        messageElement.innerText = message.user_id + ': ' + message.content;
        chatMessages.appendChild(messageElement);
    }

    function enterChatRoom(){
        console.log
    }
</script>
</body>
</html>